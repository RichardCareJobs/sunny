<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shared pub crawl â€” Sunny</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <style>
    :root { --bg:#fff; --fg:#111; --muted:#6b7280; --brand:#0f172a; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#fff;color:#111}
    .topbar{position:sticky;top:0;z-index:1000;display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-bottom:1px solid #eee;background:#fff}
    .topbar a{color:#111;text-decoration:none;font-weight:700}
    .topbar h1{margin:0;font-size:1.05rem}
    .spacer{flex:1}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.secondary{background:#f1f5f9;color:#111}
    .btn.link{background:#fff;border:1px solid #e5e7eb;color:#0a66c2}

    .layout{display:grid;grid-template-columns: 380px 1fr; height: calc(100dvh - 52px);}
    @media (max-width: 960px){ .layout{grid-template-columns: 1fr; grid-template-rows: auto 1fr;} .panel{border-right:none;border-bottom:1px solid #eee} }

    .panel{padding:14px;border-right:1px solid #eee;overflow:auto}
    .summary{color:#374151}
    .sep{height:1px;background:#eee;margin:10px 0}
    .stop{display:flex;align-items:flex-start;gap:8px;border:1px solid #eee;border-radius:12px;padding:10px;margin:8px 0;background:#fff}
    .title{font-weight:700}
    .minor{color:#6b7280;font-size:12px;margin-top:2px}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .badge{font-size:12px;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;color:#374151;background:#fff}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap}

    #map{width:100%;height:100%}
  </style>
</head>
<body>
  <div class="topbar">
    <a href="./">Sunny</a>
    <h1>Shared pub crawl</h1>
    <div class="spacer"></div>
    <button id="copy" class="btn secondary">Copy link</button>
    <button id="share" class="btn secondary">Share</button>
    <button id="openGmaps" class="btn primary">Open in Google Maps</button>
  </div>

  <div class="layout">
    <div class="panel">
      <div id="intro" class="summary">Loading crawlâ€¦</div>
      <div class="sep"></div>
      <div id="itinerary"></div>
    </div>
    <div id="map"></div>
  </div>

<script>
function decodeCrawlParam() {
  const q = new URLSearchParams(location.search);
  const c = q.get('c');
  if (!c) return null;
  const b64 = c.replace(/-/g,'+').replace(/_/g,'/');
  const json = decodeURIComponent(escape(atob(b64)));
  return JSON.parse(json);
}
function toTitle(s=""){return s? s.replace(/\b\w/g,c=>c.toUpperCase()):"";}
function haversine(lat1, lon1, lat2, lon2){ const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function minsWalk(km){ return (km/4.5)*60; }
function minsRide(km){ return 5 + (km/25)*60; }
function parseStartTime(t){ if(!t){ const d=new Date(); return new Date(d.getFullYear(),d.getMonth(),d.getDate(), d.getHours(), d.getMinutes()); }
  const [hh,mm]=t.split(':').map(Number); const d=new Date(); return new Date(d.getFullYear(),d.getMonth(),d.getDate(),hh,mm||0); }
function addMinutes(d,m){ return new Date(d.getTime()+m*60000); }
function fmtTime(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

const TILE_URL = "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png";
const TILE_ATTR = '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>';
const MARKER_ICON_URL = "icons/marker.png";
const markerIcon = L.icon({ iconUrl: MARKER_ICON_URL, iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-28] });

const map = L.map('map').setView([-33.86,151.21], 13);
L.tileLayer(TILE_URL, { maxZoom: 19, attribution: TILE_ATTR }).addTo(map);
const layer = L.layerGroup().addTo(map);

const data = decodeCrawlParam();
if (!data || !data.stops || !data.stops.length){
  document.getElementById('intro').textContent = 'No crawl data in link.';
} else {
  render(data);
}

function render(crawl){
  const it = document.getElementById('itinerary');
  const start = parseStartTime(crawl.startTime);
  let time = new Date(start);
  let prev = null, totalKm = 0;
  let poly = [];

  it.innerHTML = '';
  crawl.stops.forEach((v, i) => {
    let km = 0, travel = 0;
    if (prev){
      km = haversine(prev.lat, prev.lng, v.lat, v.lng);
      totalKm += km;
      travel = Math.max(1, Math.round((crawl.mode==='walk'? minsWalk(km) : minsRide(km))));
      time = addMinutes(time, travel);
    }
    const arrive = fmtTime(time);
    const depart = fmtTime(addMinutes(time, crawl.dwell));
    time = addMinutes(time, crawl.dwell);

    poly.push([v.lat, v.lng]);
    const html = `<strong>${i+1}. ${v.name}</strong><div class="minor">${toTitle(v.amenity || 'Pub')}${v.outdoor?' Â· ðŸŒ¿ Outdoor':''}</div>`;
    L.marker([v.lat, v.lng], { icon: markerIcon }).bindPopup(html).addTo(layer);

    const originStr = prev ? `${prev.lat},${prev.lng}` : '';
    const destStr = `${v.lat},${v.lng}`;
    const walkLink = prev ? `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(originStr)}&destination=${encodeURIComponent(destStr)}&travelmode=walking` : null;
    const transitLink = prev ? `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(originStr)}&destination=${encodeURIComponent(destStr)}&travelmode=transit` : null;
    const uberLink = `https://m.uber.com/ul/?action=setPickup&dropoff[latitude]=${v.lat}&dropoff[longitude]=${v.lng}&dropoff[nickname]=${encodeURIComponent(v.name)}`;

    it.insertAdjacentHTML('beforeend', `
      <div class="stop">
        <div style="font-weight:700">${i+1}. ${v.name}
          <div class="minor">${toTitle(v.amenity || 'Pub')}${v.outdoor?' Â· ðŸŒ¿ Outdoor':''}</div>
          <div class="badges">
            ${km>0 ? `<span class="badge">${km.toFixed(2)} km leg</span>` : ''}
            ${km>0 ? `<span class="badge">${travel} min ${crawl.mode}</span>` : ''}
            <span class="badge">Arrive ${arrive}</span>
            <span class="badge">Depart ${depart}</span>
          </div>
          <div class="btnrow">
            ${walkLink?`<a class="btn link" target="_blank" rel="noopener" href="${walkLink}">Walk</a>`:''}
            ${transitLink?`<a class="btn link" target="_blank" rel="noopener" href="${transitLink}">Transit</a>`:''}
            <a class="btn link" target="_blank" rel="noopener" href="${uberLink}">Uber</a>
            ${v.website?`<a class="btn link" target="_blank" rel="noopener" href="${v.website}">Website</a>`:''}
          </div>
        </div>
      </div>
    `);

    prev = v;
  });

  const finish = fmtTime(time);
  document.getElementById('intro').innerHTML =
    `<strong>${crawl.stops.length} stops</strong> Â· ~${totalKm.toFixed(2)} km Â· finish around <strong>${finish}</strong>`;

  const line = L.polyline(poly, { color:'#0f172a', weight:4, opacity:.9 }).addTo(layer);
  map.fitBounds(line.getBounds(), { padding:[40,40] });

  const url = new URL(location.href);
  document.getElementById('copy').onclick = async ()=> {
    try { await navigator.clipboard.writeText(url.href); alert('Link copied!'); }
    catch { prompt('Copy this link:', url.href); }
  };
  document.getElementById('share').onclick = async ()=> {
    if (navigator.share) {
      try { await navigator.share({ title:'Sunny pub crawl', url: url.href }); } catch {}
    } else {
      try { await navigator.clipboard.writeText(url.href); alert('Link copied!'); }
      catch { prompt('Copy this link:', url.href); }
    }
  };
  document.getElementById('openGmaps').onclick = ()=> {
    if (crawl.stops.length < 2) return;
    const origin = `${crawl.stops[0].lat},${crawl.stops[0].lng}`;
    const destination = `${crawl.stops[crawl.stops.length-1].lat},${crawl.stops[crawl.stops.length-1].lng}`;
    const mids = crawl.stops.slice(1, -1).map(s => `${s.lat},${s.lng}`).join('|');
    const g = new URL('https://www.google.com/maps/dir/');
    g.searchParams.set('api','1');
    g.searchParams.set('origin', origin);
    g.searchParams.set('destination', destination);
    if (mids) g.searchParams.set('waypoints', mids);
    window.open(g.toString(), '_blank');
  };
}
</script>
</body>
</html>
